# å‰²ã‚Šè¾¼ã¿ã¨ã‚¿ã‚¤ãƒã®ä»•çµ„ã¿

ğŸ¯ **ã“ã®ç« ã§å­¦ã¶ã“ã¨**
- å‰²ã‚Šè¾¼ã¿ã®å½¹å‰²ã¨ç¨®é¡
- IDT (Interrupt Descriptor Table) ã®ä»•çµ„ã¿
- APIC (Advanced Programmable Interrupt Controller) ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- ã‚¿ã‚¤ãƒã®å½¹å‰²ã¨å®Ÿè£…

ğŸ“š **å‰æçŸ¥è­˜**
- CPUãƒ¢ãƒ¼ãƒ‰é·ç§»ï¼ˆç¬¬3ç« ï¼‰
- ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—ï¼ˆç¬¬2ç« ï¼‰

---

## å‰²ã‚Šè¾¼ã¿ã¨ã¯

### æ¦‚å¿µ

**å‰²ã‚Šè¾¼ã¿ (Interrupt)** ã¯ã€CPUã«éåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šçŸ¥ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

```mermaid
sequenceDiagram
    participant CPU as CPU
    participant Device as ãƒ‡ãƒã‚¤ã‚¹
    participant Handler as å‰²ã‚Šè¾¼ã¿ãƒãƒ³ãƒ‰ãƒ©

    CPU->>CPU: é€šå¸¸å‡¦ç†å®Ÿè¡Œä¸­
    Device->>CPU: å‰²ã‚Šè¾¼ã¿ä¿¡å·
    CPU->>CPU: å®Ÿè¡Œä¸­æ–­
    CPU->>Handler: ãƒãƒ³ãƒ‰ãƒ©å®Ÿè¡Œ
    Handler->>Handler: å‰²ã‚Šè¾¼ã¿å‡¦ç†
    Handler-->>CPU: å¾©å¸°
    CPU->>CPU: é€šå¸¸å‡¦ç†å†é–‹
```

### ãªãœå‰²ã‚Šè¾¼ã¿ãŒå¿…è¦ã‹

```mermaid
graph TB
    A[å‰²ã‚Šè¾¼ã¿ã®å¿…è¦æ€§] --> B[éåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†]
    A --> C[CPUãƒªã‚½ãƒ¼ã‚¹ã®åŠ¹ç‡åŒ–]
    A --> D[ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§]

    B --> E[ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›]
    B --> F[ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚±ãƒƒãƒˆ]
    C --> G[ãƒãƒ¼ãƒªãƒ³ã‚°ä¸è¦]
    D --> H[å³åº§ã«å¿œç­”]

    style A fill:#9f9,stroke:#333,stroke-width:2px
```

**ä¸»ãªç†ç”±:**
1. **ãƒãƒ¼ãƒªãƒ³ã‚°ä¸è¦**: CPUãŒå¸¸æ™‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒãªã„
2. **å³åº§ã®å¿œç­”**: ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã«å³åº§ã«å‡¦ç†
3. **è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ**: å¤šæ•°ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’åŠ¹ç‡çš„ã«ç®¡ç†

## å‰²ã‚Šè¾¼ã¿ã®ç¨®é¡

### åˆ†é¡

```mermaid
graph TB
    A[å‰²ã‚Šè¾¼ã¿] --> B[ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢å‰²ã‚Šè¾¼ã¿]
    A --> C[ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢å‰²ã‚Šè¾¼ã¿]
    A --> D[ä¾‹å¤–]

    B --> B1[å¤–éƒ¨ãƒ‡ãƒã‚¤ã‚¹]
    B --> B2[ã‚¿ã‚¤ãƒ]
    C --> C1[INTå‘½ä»¤]
    C --> C2[ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«]
    D --> D1[ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ«ãƒˆ]
    D --> D2[é™¤ç®—ã‚¨ãƒ©ãƒ¼]

    style A fill:#9f9,stroke:#333,stroke-width:2px
```

### è©³ç´°

| ç¨®é¡ | ç™ºç”Ÿæº | ä¾‹ | ç•ªå·ç¯„å›² |
|------|--------|-----|---------|
| **ä¾‹å¤–** | CPUå†…éƒ¨ | ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ«ãƒˆã€é™¤ç®—ã‚¨ãƒ©ãƒ¼ | 0-31 |
| **ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢å‰²ã‚Šè¾¼ã¿** | å¤–éƒ¨ãƒ‡ãƒã‚¤ã‚¹ | ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã€ã‚¿ã‚¤ãƒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | 32-255 |
| **ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢å‰²ã‚Šè¾¼ã¿** | INTå‘½ä»¤ | ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã€BIOSå‘¼ã³å‡ºã— | ä»»æ„ |

## IDT (Interrupt Descriptor Table)

### æ¦‚è¦

**IDT**ã¯ã€å‰²ã‚Šè¾¼ã¿ç•ªå·ã‹ã‚‰ãƒãƒ³ãƒ‰ãƒ©ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æä¾›ã—ã¾ã™ã€‚

```mermaid
graph LR
    A[å‰²ã‚Šè¾¼ã¿ç™ºç”Ÿ<br/>å‰²ã‚Šè¾¼ã¿ç•ªå·: N] --> B[IDTå‚ç…§<br/>IDT[N]]
    B --> C[ãƒãƒ³ãƒ‰ãƒ©ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—]
    C --> D[ãƒãƒ³ãƒ‰ãƒ©å®Ÿè¡Œ]

    style B fill:#9f9,stroke:#333,stroke-width:2px
```

### æ§‹é€ 

```c
// IDT ã‚¨ãƒ³ãƒˆãƒª (64bit)
struct IDTEntry {
    UINT16  OffsetLow;     // ãƒãƒ³ãƒ‰ãƒ©ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸‹ä½16bit
    UINT16  SegmentSelector; // ã‚³ãƒ¼ãƒ‰ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
    UINT8   IST;           // Interrupt Stack Table (64bit)
    UINT8   Flags;         // ã‚¿ã‚¤ãƒ—ã€DPLã€P
    UINT16  OffsetMid;     // ãƒãƒ³ãƒ‰ãƒ©ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸­ä½16bit
    UINT32  OffsetHigh;    // ãƒãƒ³ãƒ‰ãƒ©ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸Šä½32bit
    UINT32  Reserved;
};
```

### IDT ã®é…ç½®

```
ãƒ¡ãƒ¢ãƒªä¸Šã®IDT:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IDT Entry 0     â”‚ â† é™¤ç®—ã‚¨ãƒ©ãƒ¼
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ IDT Entry 1     â”‚ â† ãƒ‡ãƒãƒƒã‚°ä¾‹å¤–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ...             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ IDT Entry 14    â”‚ â† ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ«ãƒˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ...             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ IDT Entry 32    â”‚ â† ã‚¿ã‚¤ãƒå‰²ã‚Šè¾¼ã¿
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ...             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ IDT Entry 255   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

IDTR ãƒ¬ã‚¸ã‚¹ã‚¿: IDTã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿æŒ
```

### IDTR ãƒ¬ã‚¸ã‚¹ã‚¿

```asm
; IDT ã®è¨­å®š
lidt [idt_descriptor]

; IDT Descriptor ã®æ§‹é€ 
idt_descriptor:
    dw idt_end - idt_start - 1  ; Limit
    dq idt_start                 ; Base Address
```

## 8259 PIC (Programmable Interrupt Controller)

### ãƒ¬ã‚¬ã‚·ãƒ¼ãªå‰²ã‚Šè¾¼ã¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©

**8259 PIC**ã¯ã€ãƒ¬ã‚¬ã‚·ãƒ¼BIOSæ™‚ä»£ã®å‰²ã‚Šè¾¼ã¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ã™ã€‚

```mermaid
graph TB
    subgraph "Master PIC"
    A[IRQ 0: Timer]
    B[IRQ 1: Keyboard]
    C[IRQ 2: Cascade]
    D[IRQ 3-7]
    end

    subgraph "Slave PIC"
    E[IRQ 8: RTC]
    F[IRQ 9-15]
    end

    C --> E

    style A fill:#f99,stroke:#333
    style C fill:#9f9,stroke:#333
```

### åˆ¶ç´„

- **IRQæ•°ã®åˆ¶é™**: æœ€å¤§15æœ¬ï¼ˆMaster 7æœ¬ + Slave 8æœ¬ï¼‰
- **å˜ä¸€CPU**: ãƒãƒ«ãƒãƒ—ãƒ­ã‚»ãƒƒã‚µéå¯¾å¿œ
- **å›ºå®šå„ªå…ˆåº¦**: æŸ”è»Ÿæ€§ã«æ¬ ã‘ã‚‹

## APIC (Advanced Programmable Interrupt Controller)

### æ¦‚è¦

**APIC**ã¯ã€ãƒ¢ãƒ€ãƒ³ãªãƒãƒ«ãƒã‚³ã‚¢CPUå‘ã‘ã®å‰²ã‚Šè¾¼ã¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ã™ã€‚

```mermaid
graph TB
    subgraph "I/O APIC"
    A[å¤–éƒ¨ãƒ‡ãƒã‚¤ã‚¹<br/>å‰²ã‚Šè¾¼ã¿ã‚½ãƒ¼ã‚¹]
    end

    subgraph "CPU 0"
    B1[Local APIC]
    end

    subgraph "CPU 1"
    B2[Local APIC]
    end

    subgraph "CPU N"
    B3[Local APIC]
    end

    A -->|å‰²ã‚Šè¾¼ã¿ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°| B1
    A --> B2
    A --> B3

    style A fill:#f99,stroke:#333
    style B1 fill:#9f9,stroke:#333
    style B2 fill:#9f9,stroke:#333
    style B3 fill:#9f9,stroke:#333
```

### 2ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**1. Local APIC (å„CPUã‚³ã‚¢ã«1ã¤)**
- CPUå›ºæœ‰ã®å‰²ã‚Šè¾¼ã¿å‡¦ç†
- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
- IPI (Inter-Processor Interrupt) é€ä¿¡

**2. I/O APIC (ãƒãƒƒãƒ—ã‚»ãƒƒãƒˆã«1ã¤ä»¥ä¸Š)**
- å¤–éƒ¨ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®å‰²ã‚Šè¾¼ã¿å—ä¿¡
- å‰²ã‚Šè¾¼ã¿ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- è¤‡æ•°CPUã¸ã®é…ä¿¡

### APIC ã®ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—

```
Local APIC: 0xFEE00000 (MMIO)
â”œâ”€ 0xFEE00020: Local APIC ID
â”œâ”€ 0xFEE00080: Task Priority Register
â”œâ”€ 0xFEE00320: Timer LVT
â””â”€ ...

I/O APIC: 0xFEC00000 (MMIO)
â”œâ”€ Redirection Table
â””â”€ ...
```

### å‰²ã‚Šè¾¼ã¿ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```mermaid
sequenceDiagram
    participant Device as ãƒ‡ãƒã‚¤ã‚¹
    participant IOAPIC as I/O APIC
    participant LAPIC as Local APIC
    participant CPU as CPU

    Device->>IOAPIC: å‰²ã‚Šè¾¼ã¿ä¿¡å·
    IOAPIC->>IOAPIC: Redirection Table å‚ç…§
    IOAPIC->>LAPIC: å‰²ã‚Šè¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    LAPIC->>CPU: å‰²ã‚Šè¾¼ã¿é€šçŸ¥
    CPU->>CPU: ãƒãƒ³ãƒ‰ãƒ©å®Ÿè¡Œ
```

## MSI/MSI-X (Message Signaled Interrupts)

### æ¦‚è¦

**MSI/MSI-X**ã¯ã€PCIeãƒ‡ãƒã‚¤ã‚¹ãŒä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ€ãƒ³ãªå‰²ã‚Šè¾¼ã¿æ–¹å¼ã§ã™ã€‚

```mermaid
graph LR
    A[PCIeãƒ‡ãƒã‚¤ã‚¹] -->|ãƒ¡ãƒ¢ãƒªãƒ©ã‚¤ãƒˆ| B[Local APIC]
    B --> C[CPU]

    style A fill:#9f9,stroke:#333
    style B fill:#f99,stroke:#333
```

### ãƒ¬ã‚¬ã‚·ãƒ¼å‰²ã‚Šè¾¼ã¿ã¨ã®é•ã„

| é …ç›® | ãƒ¬ã‚¬ã‚·ãƒ¼ (INTx) | MSI/MSI-X |
|------|----------------|-----------|
| æ–¹å¼ | å°‚ç”¨ä¿¡å·ç·š | ãƒ¡ãƒ¢ãƒªãƒ©ã‚¤ãƒˆ |
| å…±æœ‰ | å¯èƒ½ï¼ˆå•é¡Œã‚ã‚Šï¼‰ | å°‚ç”¨ |
| å‰²ã‚Šè¾¼ã¿æ•° | 4æœ¬ (INTA-INTD) | æœ€å¤§2048 |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | ä½ã„ | é«˜ã„ |

### ãªãœMSIãŒå„ªã‚Œã¦ã„ã‚‹ã‹

```mermaid
graph TB
    A[MSIã®åˆ©ç‚¹] --> B[å‰²ã‚Šè¾¼ã¿å…±æœ‰ä¸è¦]
    A --> C[é«˜é€Ÿ]
    A --> D[å¤šæ•°ã®å‰²ã‚Šè¾¼ã¿]

    B --> E[ç«¶åˆãªã—]
    C --> F[ãƒ¡ãƒ¢ãƒªãƒã‚¹ä½¿ç”¨]
    D --> G[ãƒ‡ãƒã‚¤ã‚¹ã”ã¨ã«å°‚ç”¨]

    style A fill:#9f9,stroke:#333,stroke-width:2px
```

## ã‚¿ã‚¤ãƒ

### ã‚¿ã‚¤ãƒã®å½¹å‰²

```mermaid
graph TB
    A[ã‚¿ã‚¤ãƒã®å½¹å‰²] --> B[ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°]
    A --> C[æ™‚åˆ»ç®¡ç†]
    A --> D[ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ]

    B --> E[ãƒ—ãƒ­ã‚»ã‚¹åˆ‡ã‚Šæ›¿ãˆ]
    C --> F[ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒ­ãƒƒã‚¯]
    D --> G[ã‚¦ã‚©ãƒƒãƒãƒ‰ãƒƒã‚°]

    style A fill:#9f9,stroke:#333,stroke-width:2px
```

### x86_64 ã®ã‚¿ã‚¤ãƒç¨®é¡

| ã‚¿ã‚¤ãƒ | å‘¨æ³¢æ•° | ç²¾åº¦ | ç”¨é€” |
|--------|--------|------|------|
| **PIT** (8254) | 1.193MHz | ä½ | ãƒ¬ã‚¬ã‚·ãƒ¼ |
| **RTC** (Real Time Clock) | 32.768kHz | ä½ | CMOSæ™‚è¨ˆ |
| **Local APIC Timer** | CPUä¾å­˜ | ä¸­ | å„CPUå›ºæœ‰ |
| **HPET** (High Precision Event Timer) | 10MHzä»¥ä¸Š | é«˜ | ãƒ¢ãƒ€ãƒ³ |
| **TSC** (Time Stamp Counter) | CPUå‘¨æ³¢æ•° | æœ€é«˜ | è¨ˆæ¸¬å°‚ç”¨ |

### PIT (Programmable Interval Timer)

**ãƒ¬ã‚¬ã‚·ãƒ¼ãªã‚¿ã‚¤ãƒ**ã§ã™ãŒã€äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã£ã¦ã„ã¾ã™ã€‚

```
I/O ãƒãƒ¼ãƒˆ:
0x40-0x43: PIT ãƒãƒ£ãƒãƒ«0-2ã€ã‚³ãƒãƒ³ãƒ‰

å‘¨æ³¢æ•°: 1.193182 MHz
åˆ†å‘¨æ¯”è¨­å®šã§å‰²ã‚Šè¾¼ã¿å‘¨æœŸã‚’æ±ºå®š
```

### Local APIC Timer

å„CPUã‚³ã‚¢ã«å†…è”µã•ã‚ŒãŸã‚¿ã‚¤ãƒã§ã™ã€‚

```c
// Local APIC Timer ã®è¨­å®šï¼ˆæ¦‚å¿µçš„ï¼‰
void SetupLocalAPICTimer(UINT32 IntervalMs) {
    // åˆæœŸã‚«ã‚¦ãƒ³ãƒˆå€¤è¨­å®š
    *((volatile UINT32*)0xFEE00380) = CalculateCount(IntervalMs);

    // ã‚¿ã‚¤ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆå®šæœŸçš„ï¼‰
    *((volatile UINT32*)0xFEE00320) = 0x20000 | TIMER_VECTOR;
}
```

### HPET (High Precision Event Timer)

ãƒ¢ãƒ€ãƒ³ãªã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨ã•ã‚Œã‚‹é«˜ç²¾åº¦ã‚¿ã‚¤ãƒã§ã™ã€‚

```
MMIO ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹: ACPI HPETãƒ†ãƒ¼ãƒ–ãƒ«ã§æŒ‡å®š
æœ€å°å‘¨æ³¢æ•°: 10MHz
æœ€å¤§ã‚«ã‚¦ãƒ³ã‚¿æ•°: 32å€‹

ç‰¹å¾´:
- é«˜ç²¾åº¦
- è¤‡æ•°ã‚¿ã‚¤ãƒãƒ¼
- 64bitã‚«ã‚¦ãƒ³ã‚¿
```

### TSC (Time Stamp Counter)

CPUå†…è”µã®ã‚«ã‚¦ãƒ³ã‚¿ã§ã€æœ€ã‚‚é«˜ç²¾åº¦ã§ã™ã€‚

```asm
rdtsc  ; EDX:EAX ã« TSC èª­ã¿è¾¼ã¿
```

**ç”¨é€”:**
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
- é«˜ç²¾åº¦æ™‚åˆ»å–å¾—

**æ³¨æ„ç‚¹:**
- å‘¨æ³¢æ•°ãŒCPUä¾å­˜
- ãƒãƒ«ãƒã‚³ã‚¢ã§ã¯åŒæœŸãŒå¿…è¦
- çœé›»åŠ›ãƒ¢ãƒ¼ãƒ‰ã§åœæ­¢ã™ã‚‹å ´åˆã‚ã‚Š

## ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã«ãŠã‘ã‚‹å‰²ã‚Šè¾¼ã¿

### UEFI ã¨å‰²ã‚Šè¾¼ã¿

UEFIãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã¯ã€é€šå¸¸**å‰²ã‚Šè¾¼ã¿ã‚’ç„¡åŠ¹åŒ–**ã—ã¦å‹•ä½œã—ã¾ã™ã€‚

```mermaid
graph LR
    A[UEFI Boot Services] --> B[å‰²ã‚Šè¾¼ã¿ç„¡åŠ¹<br/>CLIçŠ¶æ…‹]
    B --> C[ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ™ãƒ¼ã‚¹]
    C --> D[OSèµ·å‹•]
    D --> E[OS ãŒå‰²ã‚Šè¾¼ã¿è¨­å®š]

    style B fill:#f99,stroke:#333
    style E fill:#9f9,stroke:#333
```

**ç†ç”±:**
1. **å˜ç´”æ€§**: å‰²ã‚Šè¾¼ã¿ãƒãƒ³ãƒ‰ãƒ©ä¸è¦
2. **äºˆæ¸¬å¯èƒ½æ€§**: ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒæ±ºå®šçš„
3. **OSã¸ã®å¼•ãæ¸¡ã—**: OSãŒè‡ªç”±ã«è¨­å®š

### ä¾‹å¤–çš„ã«ä½¿ç”¨ã™ã‚‹ã‚±ãƒ¼ã‚¹

- **ã‚¿ã‚¤ãƒãƒ¼**: ä¸€éƒ¨ã®UEFIå®Ÿè£…ã§Local APIC Timerã‚’ä½¿ç”¨
- **ãƒ‡ãƒãƒƒã‚°**: ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆå‰²ã‚Šè¾¼ã¿

## å‰²ã‚Šè¾¼ã¿ã®åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹

### OSèµ·å‹•æ™‚ã®æµã‚Œ

```mermaid
sequenceDiagram
    participant FW as ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢
    participant Boot as ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€
    participant Kernel as ã‚«ãƒ¼ãƒãƒ«

    FW->>FW: å‰²ã‚Šè¾¼ã¿ç„¡åŠ¹
    FW->>Boot: åˆ¶å¾¡ç§»è­²
    Boot->>Boot: å‰²ã‚Šè¾¼ã¿ç„¡åŠ¹ç¶­æŒ
    Boot->>Kernel: ã‚«ãƒ¼ãƒãƒ«èµ·å‹•
    Kernel->>Kernel: IDTæ§‹ç¯‰
    Kernel->>Kernel: APICåˆæœŸåŒ–
    Kernel->>Kernel: å‰²ã‚Šè¾¼ã¿æœ‰åŠ¹åŒ–
```

### Linux ã‚«ãƒ¼ãƒãƒ«ã®ä¾‹

```mermaid
graph TB
    A[ã‚«ãƒ¼ãƒãƒ«èµ·å‹•] --> B[IDTè¨­å®š<br/>early_idt_handler_array]
    B --> C[GDT/IDTå†è¨­å®š]
    C --> D[APICæ¤œå‡ºãƒ»åˆæœŸåŒ–]
    D --> E[ãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒãƒ­ãƒ¼ãƒ‰]
    E --> F[å‰²ã‚Šè¾¼ã¿ãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²]
    F --> G[å‰²ã‚Šè¾¼ã¿æœ‰åŠ¹åŒ–]

    style A fill:#f99,stroke:#333
    style G fill:#9f9,stroke:#333
```

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€å‰²ã‚Šè¾¼ã¿ã¨ã‚¿ã‚¤ãƒã®ä»•çµ„ã¿ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ:**

- **å‰²ã‚Šè¾¼ã¿**ã¯éåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆã‚’CPUã«é€šçŸ¥ã™ã‚‹ä»•çµ„ã¿
- **IDT**ãŒå‰²ã‚Šè¾¼ã¿ç•ªå·ã¨ãƒãƒ³ãƒ‰ãƒ©ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
- **APIC**ã¯ãƒ¢ãƒ€ãƒ³ãªãƒãƒ«ãƒã‚³ã‚¢å¯¾å¿œå‰²ã‚Šè¾¼ã¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©
  - Local APIC: å„CPUã‚³ã‚¢å›ºæœ‰
  - I/O APIC: å¤–éƒ¨ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†
- **MSI/MSI-X**ã¯PCIeãƒ‡ãƒã‚¤ã‚¹ã®é«˜æ€§èƒ½å‰²ã‚Šè¾¼ã¿æ–¹å¼
- **ã‚¿ã‚¤ãƒ**ã®ç¨®é¡ï¼šPITï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰ã€HPETï¼ˆãƒ¢ãƒ€ãƒ³ï¼‰ã€TSCï¼ˆé«˜ç²¾åº¦ï¼‰

**APIC ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:**

```mermaid
graph TB
    A[å¤–éƒ¨ãƒ‡ãƒã‚¤ã‚¹] --> B[I/O APIC<br/>0xFEC00000]
    B --> C1[Local APIC 0<br/>0xFEE00000]
    B --> C2[Local APIC 1]
    B --> C3[Local APIC N]

    C1 --> D1[CPU 0]
    C2 --> D2[CPU 1]
    C3 --> D3[CPU N]

    style B fill:#f99,stroke:#333
    style C1 fill:#9f9,stroke:#333
    style C2 fill:#9f9,stroke:#333
    style C3 fill:#9f9,stroke:#333
```

---

**æ¬¡ç« ã§ã¯ã€UEFI ãƒ–ãƒ¼ãƒˆãƒ•ã‚§ãƒ¼ã‚ºã®å…¨ä½“åƒã‚’è¦‹ã¦ã„ãã¾ã™ã€‚**

ğŸ“š **å‚è€ƒè³‡æ–™**
- [IntelÂ® 64 and IA-32 Architectures Software Developer's Manual - Volume 3, Chapter 10: Advanced Programmable Interrupt Controller (APIC)](https://www.intel.com/sdm)
- [IntelÂ® 64 and IA-32 Architectures Software Developer's Manual - Volume 3, Chapter 6: Interrupt and Exception Handling](https://www.intel.com/sdm)
- [IA-PC HPET Specification](https://www.intel.com/content/dam/www/public/us/en/documents/technical-specifications/software-developers-hpet-spec-1-0a.pdf)
- [PCI Local Bus Specification - MSI/MSI-X](https://pcisig.com/specifications)
